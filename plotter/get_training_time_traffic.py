"""
    Class to retrieve training time and traffic data about execution of RL algorithms
"""

import os
import numpy as np
import csv

from config import FrameworkConfiguration


class GetTrainingTimeTraffic(object):
    def __init__(self, date_to_retrieve='YY_mm_dd_HH_MM_SS', target_output="algorithm.csv"):
        if date_to_retrieve != 'YY_mm_dd_HH_MM_SS':
            self.date_to_retrieve = date_to_retrieve  # Date must be in format %Y_%m_%d_%H_%M_%S
        else:
            print("Invalid date")
            exit(1)
        self.target_output = target_output

    def run(self):

        directory = FrameworkConfiguration.directory + 'output/log/'
        log_file = directory + 'log_' + self.date_to_retrieve + '.log'

        print(log_file)

        # Each non empty line is a sent command
        # Command of power is substituted by episode finishing line
        # Minus last line that is the total time

        counter_line = -1
        with open(log_file) as f:
            for line in f:
                if len(line.strip()) != 0:  # Not empty lines
                    counter_line += 1
            last_line = line

        secs = float(last_line.split()[3])
        np.set_printoptions(formatter={'float': lambda output: "{0:0.4f}".format(output)})

        print("Total lines", counter_line)
        print("Last line", last_line)
        print("Seconds", secs)

        if not os.path.isfile(self.target_output):  # If file does not exist
            # Write header
            with open(self.target_output, mode='w') as output_file:
                output_writer = csv.writer(output_file, delimiter=',', quotechar='"', quoting=csv.QUOTE_MINIMAL)
                output_writer.writerow(['Date', 'Training_time', 'Sent_commands'])

        with open(self.target_output, mode="a") as output_file:
            output_writer = csv.writer(output_file, delimiter=',', quotechar='"', quoting=csv.QUOTE_MINIMAL)
            output_writer.writerow([self.date_to_retrieve, secs, counter_line])


def get_data_before_tuning_unique_path():
    """
    Get training time in seconds and traffic generated by training process,
    only sent commands,
    into a file that appends or writes:

    Date | Training time | Sent commands
    date |           123 |           150

    All the executions refer to the same path 1
    """

    from date_for_graphs_before_tuning_path2 import sarsa
    from date_for_graphs_before_tuning_path2 import sarsa_lambda
    from date_for_graphs_before_tuning_path2 import qlearning
    from date_for_graphs_before_tuning_path2 import qlearning_lambda

    for dat in sarsa:
        GetTrainingTimeTraffic(date_to_retrieve=dat, target_output='0_sarsa.csv').run()

    for dat in sarsa_lambda:
        GetTrainingTimeTraffic(date_to_retrieve=dat, target_output='0_sarsa_lambda.csv').run()

    for dat in qlearning:
        GetTrainingTimeTraffic(date_to_retrieve=dat, target_output='0_qlearning.csv').run()

    for dat in qlearning_lambda:
        GetTrainingTimeTraffic(date_to_retrieve=dat, target_output='0_qlearning_lambda.csv').run()


def get_data_algos_path(sarsa, sarsa_lambda, qlearning, qlearning_lambda, path=None):
    """
    Retrieving training time and traffic for all different algorithms and append into related csv files
    """

    for dat in sarsa:
        GetTrainingTimeTraffic(date_to_retrieve=dat, target_output='path' + str(path) + '_sarsa.csv').run()

    for dat in sarsa_lambda:
        GetTrainingTimeTraffic(date_to_retrieve=dat, target_output='path' + str(path) + '_sarsa_lambda.csv').run()

    for dat in qlearning:
        GetTrainingTimeTraffic(date_to_retrieve=dat, target_output='path' + str(path) + '_qlearning.csv').run()

    for dat in qlearning_lambda:
        GetTrainingTimeTraffic(date_to_retrieve=dat, target_output='path' + str(path) + '_qlearning_lambda.csv').run()


if __name__ == '__main__':
    get_data_before_tuning_unique_path()

    # Plot all paths
    target_path = 1
    print("PATH ", target_path)

    from date_for_graphs_path1 import sarsa_dates
    from date_for_graphs_path1 import sarsa_lambda_dates
    from date_for_graphs_path1 import qlearning_dates
    from date_for_graphs_path1 import qlearning_lambda_dates

    get_data_algos_path(sarsa_dates, sarsa_lambda_dates, qlearning_dates, qlearning_lambda_dates, path=target_path)
    target_path = 2
    print("PATH ", target_path)

    from date_for_graphs_path2 import sarsa_dates
    from date_for_graphs_path2 import sarsa_lambda_dates
    from date_for_graphs_path2 import qlearning_dates
    from date_for_graphs_path2 import qlearning_lambda_dates

    get_data_algos_path(sarsa_dates, sarsa_lambda_dates, qlearning_dates, qlearning_lambda_dates, path=target_path)

    target_path = 3
    print("PATH ", target_path)

    from date_for_graphs_path3 import sarsa_dates
    from date_for_graphs_path3 import sarsa_lambda_dates
    from date_for_graphs_path3 import qlearning_dates
    from date_for_graphs_path3 import qlearning_lambda_dates

    get_data_algos_path(sarsa_dates, sarsa_lambda_dates, qlearning_dates, qlearning_lambda_dates, path=target_path)
